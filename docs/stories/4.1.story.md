# Story 4.1: Gemini API 설정 및 연동

## Status
Ready for Review

## Story

**As a** 개발자,
**I want** Google Gemini API를 프로젝트에 설정하고 연동하여 AI 기능의 기반을 구축해야 하며,
**so that** 노트의 자동 요약과 태그 생성 기능을 구현할 수 있다.

## Acceptance Criteria

1. Google Gemini API 키를 환경 변수로 안전하게 설정한다.
2. Gemini API 클라이언트를 초기화하고 연결을 테스트한다.
3. API 호출을 위한 서버 액션을 구현한다.
4. 토큰 제한(8k 토큰)을 관리하는 로직을 구현한다.
5. API 호출 시 에러 핸들링과 재시도 로직을 구현한다.
6. API 응답을 파싱하고 검증하는 로직을 구현한다.

## Tasks / Subtasks

- [x] Task 1: 환경 변수 설정 및 보안 구성 (AC: 1)
  - [x] Subtask 1.1: .env.local에 GEMINI_API_KEY 추가
  - [x] Subtask 1.2: 환경 변수 검증 로직 구현
  - [x] Subtask 1.3: 서버 사이드에서만 API 키 접근하도록 보안 설정
- [x] Task 2: Gemini API 클라이언트 구현 (AC: 2)
  - [x] Subtask 2.1: @google/genai 패키지 설치
  - [x] Subtask 2.2: Gemini API 클라이언트 초기화 함수 구현
  - [x] Subtask 2.3: API 연결 테스트 함수 구현
- [x] Task 3: 서버 액션 구현 (AC: 3)
  - [x] Subtask 3.1: lib/ai/gemini.ts 유틸리티 함수 생성
  - [x] Subtask 3.2: app/api/ai/summarize/route.ts API 엔드포인트 구현
  - [x] Subtask 3.3: app/api/ai/tags/route.ts API 엔드포인트 구현
- [x] Task 4: 토큰 제한 관리 구현 (AC: 4)
  - [x] Subtask 4.1: 텍스트 길이를 토큰으로 변환하는 함수 구현
  - [x] Subtask 4.2: 8k 토큰 제한 검증 로직 구현
  - [x] Subtask 4.3: 텍스트 자르기 및 요약 로직 구현
- [x] Task 5: 에러 핸들링 및 재시도 로직 구현 (AC: 5)
  - [x] Subtask 5.1: API 호출 실패 시 재시도 로직 구현
  - [x] Subtask 5.2: 타임아웃 처리 구현
  - [x] Subtask 5.3: 에러 로깅 및 모니터링 구현
- [x] Task 6: API 응답 파싱 및 검증 구현 (AC: 6)
  - [x] Subtask 6.1: Gemini API 응답 타입 정의
  - [x] Subtask 6.2: 응답 파싱 및 검증 함수 구현
  - [x] Subtask 6.3: 잘못된 응답 처리 로직 구현
- [x] Task 7: 테스트 구현
  - [x] Subtask 7.1: Gemini API 클라이언트 단위 테스트
  - [x] Subtask 7.2: 서버 액션 통합 테스트
  - [x] Subtask 7.3: 에러 핸들링 테스트
  - [x] Subtask 7.4: 토큰 제한 테스트

## Dev Notes

### 이전 스토리 인사이트
- Epic 2의 노트 관리 시스템이 완료되어 노트 데이터 구조가 확립됨
- Drizzle ORM을 통한 데이터베이스 연동이 구현됨
- 서버 액션 패턴이 Next.js App Router에서 정상 작동함

### 기술 스택 정보
[Source: architecture.md#1]
- **AI 모델:** Google Gemini API (요약/태깅)
- **프레임워크:** Next.js (App Router, Server Actions)
- **호스팅:** Vercel (Preview/Prod)

### Gemini API 패키지 정보
[Source: Context7 - /googleapis/js-genai]
- **올바른 패키지:** `@google/genai` (NPM)
- **설치 명령어:** `npm install @google/genai`
- **잘못된 패키지:** `@google/generative-ai`, `@google-ai/generativelanguage` (사용 금지)
- **주요 클래스:** `GoogleGenAI`
- **API 키 환경변수:** `GEMINI_API_KEY`

### 데이터 모델
[Source: architecture.md#2]
- **summaries 테이블:** note_id, model, content, created_at
- **note_tags 테이블:** note_id, tag
- AI 처리 결과는 기존 노트와 연결되어 저장됨

### 서버 액션 패턴
[Source: architecture.md#4]
- `regenerateAI` – Gemini 호출 후 요약/태그 저장
- 서버 액션을 통한 AI API 호출 구현 필요

### Gemini API 사용법
[Source: Context7 - /googleapis/js-genai]
- **초기화:** `const ai = new GoogleGenAI({apiKey: process.env.GEMINI_API_KEY});`
- **텍스트 생성:** `ai.models.generateContent({model: "gemini-2.0-flash", contents: "prompt"})`
- **스트리밍:** `ai.models.generateContentStream()` 사용 가능
- **설정 옵션:** maxOutputTokens, temperature, topP, topK 등
- **환경변수 자동 사용:** `new GoogleGenAI({})` - GEMINI_API_KEY 자동 로드

### 성능 가드레일
[Source: architecture.md#6]
- 요약 길이 제한: 8k 토큰
- Gemini 무료 할당 활용
- 비동기 처리 및 로딩 상태 관리 필요

### 파일 위치
- API 유틸리티: `lib/ai/gemini.ts`
- API 엔드포인트: `app/api/ai/summarize/route.ts`, `app/api/ai/tags/route.ts`
- 환경 변수: `.env.local`
- 테스트 파일: `__tests__/ai/`

### 보안 고려사항
[Source: architecture.md#3]
- API 키는 서버 사이드에서만 접근
- 사용자 스코프 확인 필요
- Supabase 서비스 롤 키와 동일한 보안 수준 적용

### 테스트 요구사항
- Jest와 Testing Library 사용
- API 모킹을 통한 단위 테스트
- 실제 API 호출을 통한 통합 테스트 (제한적)
- 에러 시나리오 테스트 필수

## Testing

### 테스트 파일 위치
- `__tests__/ai/gemini-client.test.ts`
- `__tests__/api/ai/summarize.test.ts`
- `__tests__/api/ai/tags.test.ts`

### 테스트 표준
- Jest 프레임워크 사용
- API 호출은 모킹하여 테스트
- 에러 케이스와 성공 케이스 모두 테스트
- 토큰 제한 검증 테스트 필수

### 테스트 요구사항
- Gemini API 클라이언트 초기화 테스트
- 토큰 제한 검증 로직 테스트
- 에러 핸들링 및 재시도 로직 테스트
- API 응답 파싱 및 검증 테스트

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-19 | 1.0 | 초기 스토리 생성 | Bob (SM) |
| 2024-12-19 | 1.1 | @google/genai 패키지 정보 및 사용법 추가 | Bob (SM) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (2024-12-19)

### Debug Log References
- 모든 AI 모듈이 정상적으로 구현됨
- 에러 핸들링 및 재시도 로직이 완벽하게 작동
- 토큰 제한 관리가 정확하게 구현됨
- 폴백 메커니즘이 API 실패 시에도 사용자 경험을 보장

### Completion Notes List
- ✅ 환경 변수 설정 및 보안 구성 완료
- ✅ @google/genai 패키지 설치 및 클라이언트 구현 완료
- ✅ 요약 및 태그 생성 API 엔드포인트 구현 완료
- ✅ 토큰 계산 및 제한 관리 로직 구현 완료
- ✅ 지수 백오프 재시도 및 타임아웃 처리 구현 완료
- ✅ 에러 분류 및 사용자 친화적 메시지 구현 완료
- ✅ 응답 검증 및 폴백 메커니즘 구현 완료
- ✅ 포괄적인 테스트 스위트 구현 완료

### File List
**새로 생성된 파일:**
- `.env.local` - GEMINI_API_KEY 환경 변수 추가
- `lib/ai/config.ts` - 환경 변수 검증 및 설정
- `lib/ai/gemini.ts` - Gemini API 클라이언트 및 유틸리티
- `lib/ai/test-connection.ts` - API 연결 테스트 함수
- `lib/ai/token-utils.ts` - 토큰 계산 및 제한 관리
- `lib/ai/text-processor.ts` - 텍스트 처리 및 요약 로직
- `lib/ai/retry-utils.ts` - 재시도 및 백오프 로직
- `lib/ai/timeout-utils.ts` - 타임아웃 처리 유틸리티
- `lib/ai/error-handler.ts` - 에러 분류 및 처리
- `lib/ai/types.ts` - AI 관련 타입 정의
- `lib/ai/response-validator.ts` - 응답 파싱 및 검증
- `lib/ai/fallback-handler.ts` - 폴백 메커니즘
- `app/api/ai/summarize/route.ts` - 요약 API 엔드포인트
- `app/api/ai/tags/route.ts` - 태그 생성 API 엔드포인트
- `__tests__/ai/gemini-client.test.ts` - Gemini 클라이언트 테스트
- `__tests__/api/ai/summarize.test.ts` - 요약 API 테스트
- `__tests__/ai/error-handler.test.ts` - 에러 핸들링 테스트
- `__tests__/ai/token-utils.test.ts` - 토큰 유틸리티 테스트

**수정된 파일:**
- `package.json` - @google/genai 의존성 추가

## QA Results
*이 섹션은 QA 에이전트가 검토 중에 채워집니다*
